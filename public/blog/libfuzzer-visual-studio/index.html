<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content="light dark" name=color-scheme><title>Building libFuzzer fuzzers on Windows with cmake/Visual Studio</title><meta name=description><link href=/img/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=/img/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=/img/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><link href=https://fonts.googleapis.com rel=preconnect><link href=https://fonts.gstatic.com rel=preconnect><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&family=Jost&display=swap" rel=stylesheet><link href=https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css rel=stylesheet><link href=/css/var.css rel=stylesheet><link href=/css/base.css rel=stylesheet><link href=/css/header.css rel=stylesheet><link href=/css/footer.css rel=stylesheet><link href=/css/post.css rel=stylesheet><body><script>if(localStorage.getItem('theme')=='dark'){document.body.classList.add('dark-mode');}</script><header class=blur><div class=top><a class="header blog" href=/blog><i class="ri-quill-pen-line ri-2x"></i><span>Security and stuff</span></a><div class=icon><a aria-label=home href=/ id=go-home><i class="ri-user-6-line ri-xl"></i></a><a aria-label="rss feed" href=/blog/feed.xml><i class="ri-rss-line ri-xl"></i></a><button aria-label="dark light mode switch" id=color-toggle><i class="ri-moon-line ri-xl"></i></button><button aria-label="table of content" id=toc-toggle><i class="ri-menu-2-line ri-xl"></i></button></div></div><div id=progress-bar></div></header><div class=wrap><div class=blank></div><main><div id=top></div><article><h1>Building libFuzzer fuzzers on Windows with cmake/Visual Studio</h1><div id=post-info><div class=date><span id=publish>2019-08-07</span></div><div class=tags><a class=tag href=https://ekse.oops.wtf/tags/libfuzzer><i class="ri-hashtag ri-sm"></i><span>libfuzzer</span></a><a class=tag href=https://ekse.oops.wtf/tags/visual-studio><i class="ri-hashtag ri-sm"></i><span>Visual Studio</span></a><a class=tag href=https://ekse.oops.wtf/tags/fuzzing><i class="ri-hashtag ri-sm"></i><span>fuzzing</span></a></div></div><p>libFuzzer is awesome and is currently my go-to fuzzing tool, so I was super excited last week when I learned that both <a rel="nofollow noreferrer" href=https://llvm.org/docs/LibFuzzer.html>libFuzzer</a> and <a rel="nofollow noreferrer" href=https://clang.llvm.org/docs/AddressSanitizer.html>AddressSanitizer</a> are now supported on Windows! I put together a couple notes on how I got it to work with a cmake + Visual Studio project.<h2 id=configuration-steps>Configuration steps</h2><p>The first step is to install a snapshot of clang 9 which can be downloaded from <a rel="nofollow noreferrer" href=https://llvm.org/builds/>https://llvm.org/builds/</a>.<p>We also need to install the clang support for Visual Studio. In Visual Studio Installer, it can be found under "Individual Components" as "C++ Clang-cl for v142 build tools".<h2 id=project-generation>Project generation</h2><p>The next step is to generate the cmake build using the <code>ClangCl</code> toolset. Here <code>WASM_FUZZING</code> is a flag specific to <code>libwasm-vulnerable</code> that is used to build the fuzzers (see the project <a rel="nofollow noreferrer" href=https://github.com/ekse/libwasm-vulnerable/blob/master/CMakeLists.txt#L18>CMakeLists.txt</a> for details).<pre style=background-color:#2e3440;color:#d8dee9;><code><span>cmake -G "Visual Studio 16" -T ClangCl -DWASM_FUZZING=ON ../..
</span></code></pre><p>Next, open the <code>libwasm.sln</code> project in Visual Studio. A limitation of libFuzzer on Windows is that incremental builds are not supported. To avoid this issue, I build the project in "Release" mode.<p>Another limitation of libFuzzer on Windows is that it only supports the /MT runtime library (it will fail to compile with /MD or /MTd). We need to change it for both libwasm and FuzzLibwasm. To do that, right-click on the project, select "Properties", then under "Configuration properties" / "C/C++" / "Code generation", set "Runtime library" to "Multithread /MT".<p>The last thing we need to fix is adding the libFuzzer libraries as they are not automatically added. To do that, open the Properties page of FuzzLibwasm, go to "Linking" / "Entries" and open "Additional Dependencies". Add the following lines (the paths might be different on your system).<pre style=background-color:#2e3440;color:#d8dee9;><code><span>C:\Program Files\LLVM\lib\clang\9.0.0\lib\windows\clang_rt.asan-preinit-x86_64.lib
</span><span>C:\Program Files\LLVM\lib\clang\9.0.0\lib\windows\clang_rt.asan-x86_64.lib
</span><span>C:\Program Files\LLVM\lib\clang\9.0.0\lib\windows\clang_rt.asan_cxx-x86_64.lib
</span><span>C:\Program Files\LLVM\lib\clang\9.0.0\lib\windows\clang_rt.fuzzer-x86_64.lib
</span></code></pre><p>FuzzLibwasm should now build and run normally (and should find a crash almost right away).<pre style=background-color:#2e3440;color:#d8dee9;><code><span>C:\projects\Security\libwasm-vulnerable\builds\Fuzzing2>fuzzers\Release\FuzzLibwasm.exe
</span><span>INFO: Seed: 3746082236
</span><span>INFO: Loaded 1 modules   (331 inline 8-bit counters): 331 [00007FF72401B908, 00007FF72401BA53),
</span><span>INFO: Loaded 1 PC tables (331 PCs): 331 [00007FF723FF3EA8,00007FF723FF5358),
</span><span>INFO: -max_len is not provided; libFuzzer will not generate inputs larger than 4096 bytes
</span><span>INFO: A corpus is not provided, starting from an empty corpus
</span><span>#2      INITED cov: 6 ft: 6 corp: 1/1b exec/s: 0 rss: 62Mb
</span><span>=================================================================
</span><span>==20928==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x11e35af80893 at pc 0x7ff723e68a02 bp 0x001618efee90 sp 0x001618efeed8
</span><span>READ of size 1 at 0x11e35af80893 thread T0
</span><span>    #0 0x7ff723e68a01 in WasmDisasm_NextInstruction+0x6d1 (C:\projects\Security\libwasm-vulnerable\builds\Fuzzing2\fuzzers\Release\FuzzLibwasm.exe+0x140008a01)
</span><span>    #1 0x7ff723e61115 in LLVMFuzzerTestOneInput+0x65 (C:\projects\Security\libwasm-vulnerable\builds\Fuzzing2\fuzzers\Release\FuzzLibwasm.exe+0x140001115)
</span><span>    #2 0x7ff723eb0edd in fuzzer::Fuzzer::ExecuteCallback C:\src\llvm_package_363781\llvm\projects\compiler-rt\lib\fuzzer\FuzzerLoop.cpp:553
</span><span>    #3 0x7ff723eb0296 in fuzzer::Fuzzer::RunOne C:\src\llvm_package_363781\llvm\projects\compiler-rt\lib\fuzzer\FuzzerLoop.cpp:469
</span><span>    #4 0x7ff723eb2030 in fuzzer::Fuzzer::MutateAndTestOne C:\src\llvm_package_363781\llvm\projects\compiler-rt\lib\fuzzer\FuzzerLoop.cpp:695
</span><span>    #5 0x7ff723eb2df5 in fuzzer::Fuzzer::Loop C:\src\llvm_package_363781\llvm\projects\compiler-rt\lib\fuzzer\FuzzerLoop.cpp:831
</span><span>    #6 0x7ff723ea725f in fuzzer::FuzzerDriver C:\src\llvm_package_363781\llvm\projects\compiler-rt\lib\fuzzer\FuzzerDriver.cpp:825
</span><span>    #7 0x7ff723ef11d2 in main C:\src\llvm_package_363781\llvm\projects\compiler-rt\lib\fuzzer\FuzzerMain.cpp:19
</span><span>    #8 0x7ff723f49b5b in __scrt_common_main_seh d:\agent\_work\3\s\src\vctools\crt\vcstartup\src\startup\exe_common.inl:288
</span><span>    #9 0x7ffa07227973 in BaseThreadInitThunk+0x13 (C:\WINDOWS\System32\KERNEL32.dll+0x180017973)
</span><span>    #10 0x7ffa0913a270 in RtlUserThreadStart+0x20 (C:\WINDOWS\SYSTEM32\ntdll.dll+0x18006a270)
</span><span>0x11e35af80893 is located 0 bytes to the right of 3-byte region [0x11e35af80890,0x11e35af80893)
</span><span>allocated by thread T0 here:
</span><span>    #0 0x7ff723e96924 in operator new[] C:\src\llvm_package_363781\llvm\projects\compiler-rt\lib\asan\asan_new_delete.cc:102
</span><span>    #1 0x7ff723eb0df1 in fuzzer::Fuzzer::ExecuteCallback C:\src\llvm_package_363781\llvm\projects\compiler-rt\lib\fuzzer\FuzzerLoop.cpp:538
</span><span>    #2 0x7ff723eb0296 in fuzzer::Fuzzer::RunOne C:\src\llvm_package_363781\llvm\projects\compiler-rt\lib\fuzzer\FuzzerLoop.cpp:469
</span><span>    #3 0x7ff723eb2030 in fuzzer::Fuzzer::MutateAndTestOne C:\src\llvm_package_363781\llvm\projects\compiler-rt\lib\fuzzer\FuzzerLoop.cpp:695
</span><span>    #4 0x7ff723eb2df5 in fuzzer::Fuzzer::Loop C:\src\llvm_package_363781\llvm\projects\compiler-rt\lib\fuzzer\FuzzerLoop.cpp:831
</span><span>    #5 0x7ff723ea725f in fuzzer::FuzzerDriver C:\src\llvm_package_363781\llvm\projects\compiler-rt\lib\fuzzer\FuzzerDriver.cpp:825
</span><span>    #6 0x7ff723ef11d2 in main C:\src\llvm_package_363781\llvm\projects\compiler-rt\lib\fuzzer\FuzzerMain.cpp:19
</span><span>    #7 0x7ff723f49b5b in __scrt_common_main_seh d:\agent\_work\3\s\src\vctools\crt\vcstartup\src\startup\exe_common.inl:288
</span><span>    #8 0x7ffa07227973 in BaseThreadInitThunk+0x13 (C:\WINDOWS\System32\KERNEL32.dll+0x180017973)
</span><span>    #9 0x7ffa0913a270 in RtlUserThreadStart+0x20 (C:\WINDOWS\SYSTEM32\ntdll.dll+0x18006a270)
</span><span>SUMMARY: AddressSanitizer: heap-buffer-overflow (C:\projects\Security\libwasm-vulnerable\builds\Fuzzing2\fuzzers\Release\FuzzLibwasm.exe+0x140008a01) in WasmDisasm_NextInstruction+0x6d1
</span><span>Shadow bytes around the buggy address:
</span><span>  0x041bc65700c0: fa fa 05 fa fa fa fd fa fa fa 06 fa fa fa 00 00
</span><span>  0x041bc65700d0: fa fa 00 00 fa fa 00 fa fa fa 00 fa fa fa 00 fa
</span><span>  0x041bc65700e0: fa fa 00 00 fa fa 00 fa fa fa 00 fa fa fa fd fd
</span><span>  0x041bc65700f0: fa fa fd fd fa fa fd fd fa fa fd fa fa fa fd fa
</span><span>  0x041bc6570100: fa fa fd fa fa fa fd fa fa fa fd fa fa fa fd fa
</span><span>=>0x041bc6570110: fa fa[03]fa fa fa fa fa fa fa fa fa fa fa fa fa
</span><span>  0x041bc6570120: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
</span><span>  0x041bc6570130: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
</span><span>  0x041bc6570140: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
</span><span>  0x041bc6570150: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
</span><span>  0x041bc6570160: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
</span><span>Shadow byte legend (one shadow byte represents 8 application bytes):
</span><span>  Addressable:           00
</span><span>  Partially addressable: 01 02 03 04 05 06 07
</span><span>  Heap left redzone:       fa
</span><span>  Freed heap region:       fd
</span><span>  Stack left redzone:      f1
</span><span>  Stack mid redzone:       f2
</span><span>  Stack right redzone:     f3
</span><span>  Stack after return:      f5
</span><span>  Stack use after scope:   f8
</span><span>  Global redzone:          f9
</span><span>  Global init order:       f6
</span><span>  Poisoned by user:        f7
</span><span>  Container overflow:      fc
</span><span>  Array cookie:            ac
</span><span>  Intra object redzone:    bb
</span><span>  ASan internal:           fe
</span><span>  Left alloca redzone:     ca
</span><span>  Right alloca redzone:    cb
</span><span>  Shadow gap:              cc
</span><span>==20928==ABORTING
</span><span>MS: 2 InsertByte-InsertByte-; base unit: adc83b19e793491b1c6ea0fd8b46cd9f32e592fc
</span><span>0x11,0xa,0x2d,
</span><span>\x11\x0a-
</span><span>artifact_prefix='./'; Test unit written to ./crash-dac57cac066b9b5ec2f3f5f64595a40609d52e80
</span><span>Base64: EQot
</span></code></pre></article></main><aside class=blur><nav><ul><li><a class=toc-h2 href=#configuration-steps>Configuration steps</a><li><a class=toc-h2 href=#project-generation>Project generation</a></ul></nav><a aria-label="back to top" href=#top id=back-to-top><i class="ri-arrow-up-s-line ri-2x"></i></a></aside></div><footer><div class=copyright>Copyright © 2022 Sébastien Duquette. All rights reserved.</div><div class=credits><span>Powered by <a rel="noreferrer noopener" href=https://www.getzola.org/ target=_blank>Zola</a> and <a rel="noreferrer noopener" href=https://github.com/isunjn/serene target=_blank>Serene</a></span></div></footer><script src=/js/dark.js></script><script src=/js/toc.js></script><script src=/js/progress.js></script><script src=/js/lightense.min.js></script><script src=/js/img.js></script>